C51 COMPILER V9.52.0.0   SYS_RUN                                                           12/29/2017 16:22:31 PAGE 1   


C51 COMPILER V9.52.0.0, COMPILATION OF MODULE SYS_RUN
OBJECT MODULE PLACED IN .\Objects\sys_run.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE USER\SYS_RUN\sys_run.c LARGE OPTIMIZE(8,SPEED) BROWSE INCDIR(..\project;
                    -.\USER\BUZZER;.\USER\charge;.\USER\common;.\USER\DC_MOTOR;.\USER\EEPROM;.\USER\EXINT;.\USER\IIC;.\USER\inc;.\USER\ION;.\
                    -USER\M26;.\USER\PWM;.\USER\Sensor;.\USER\step_motor;.\USER\SYS_RUN;.\USER\timer;.\USER\TM1620;.\USER\touch_key;.\USER\UA
                    -RT;.\USER\UV;.\USER\LVI) DEBUG OBJECTEXTEND PRINT(.\Listings\sys_run.lst) TABS(2) OBJECT(.\Objects\sys_run.obj)

line level    source

   1          #include <stdio.h>
   2          #include "global.h"
   3          #include "sys_run.h"
   4          #include "dc_motor.h"
   5          #include "step_motor.h"
   6          #include "sensor.h"
   7          #include "buzzer.h"
   8          #include "UV.h"
   9          #include "wifi_uart.h"
  10          #include "common.h"
  11          #include "ION.h"
  12          #include "debug_uart.h"
  13          #include "TM1620.h"
  14          #include "timer.h"
  15          #include "M26.h"
  16          
  17          
  18          extern M26_Cmd_Typedef m26_cmd_info;
  19          
  20          
  21          
  22          //∑¿÷π≤÷√≈ªµ¡À£¨ø™ª˙ ±±ÿ–ÎΩ¯––≤÷√≈ºÏ≤‚°£»Áπ˚≤÷√≈ªµ¡À‘Ÿ¥Úø™∑Áª˙ø…ƒ‹ª·…’ªµ∑Áª˙
  23          void sys_init_check(void)
  24          {
  25   1          //unsigned char delay_1s_times = 0;
  26   1      
  27   1          if(!DOOR_CHECK_PIN)
  28   1          {
  29   2              //¥À¥¶º”µƒIs_Door_Open = 1£¨“ÚŒ™∏’…œµÁ«Èøˆœ¬Is_Door_Open=0£¨Door_Close()∫Ø ˝÷–ª·≈–∂œ»Áπ˚øˆœ¬Is_Doo
             -r_Open==0£¨‘Ú÷±Ω”∑µªÿ
  30   2              Is_Door_Open = 1;
  31   2              Door_Close();
  32   2          }
  33   1          else
  34   1          {
  35   2              return;
  36   2          }
  37   1          while(1)
  38   1          {
  39   2              if(_test_timeflag(g_2ms_flag))
  40   2              {
  41   3                  g_2ms_flag = 0;
  42   3                  TurnMotor();           
  43   3              } 
  44   2            
  45   2              if(_test_timeflag(g_1s_flag))
  46   2              {
  47   3                  g_1s_flag = 0;
  48   3                  //delay_1s_times += 1;
  49   3                  if(beats == 0)
  50   3                  {
  51   4                      //IsSysFault = 0;
C51 COMPILER V9.52.0.0   SYS_RUN                                                           12/29/2017 16:22:31 PAGE 2   

  52   4                      return;
  53   4                  }           
  54   3              }
  55   2          }
  56   1      }
  57          
  58          
  59          
  60          void sys_start(void)
  61          {
  62   1          sys_start_time = get_sys_stime();
  63   1          UV_On();
  64   1          ION_On();
  65   1        
  66   1          //ø™∆ÙUVµ∆∫Û—” ±“ª∂Œ ±º‰£¨≤ª»√À˘”–…Ë±∏Õ¨ ±∆Ù∂Ø  
  67   1          while(get_sys_stime() < (sys_start_time + 1)) ;
  68   1        
  69   1          Buzzer_Power_On();  
  70   1      
  71   1          if(Is_Door_Open == 0 || (Is_Door_Open == 1 && DOOR_CHECK_PIN == 1))
  72   1          {
  73   2              Door_Open();
  74   2          }
  75   1          Start_DC_Motor();
  76   1          
  77   1          
  78   1          sys_mode = RUNNING;
  79   1          IsFanRunning = 1;
  80   1          IsSpeedChanged = 1;
  81   1          TM1620_LED_Control(LED_SLEEP_MODE,LED_OFF);
  82   1          TM1620_LED_Control(LED_SPEED_LOW,LED_ON);
  83   1          
  84   1          Is_close_by_man = 0;
  85   1      }
  86          
  87          void sys_stop(void)
  88          {
  89   1          sys_stop_time = get_sys_stime();
  90   1          Buzzer_Power_Off();
  91   1          sys_mode = STANDBY;
  92   1          Stop_DC_Motor();
  93   1          Door_Close();
  94   1          UV_Off();
  95   1          ION_Off();  
  96   1          IsSpeedChanged = 1;
  97   1      
  98   1          TM1620_LED_Control(LED_ALL,LED_OFF);
  99   1          TM1620_LED_Control(LED_SLEEP_MODE,LED_ON);
 100   1        
 101   1          if(run_mode == 1)
 102   1          {  
 103   2             stop_sys_smart_mode();
 104   2          }
 105   1          
 106   1          if(is_sys_auto_check == 1)
 107   1          {
 108   2              stop_sys_auto_check();
 109   2          }
 110   1        
 111   1          IsUVfault = 0;
 112   1          Is_close_by_man = 1;
 113   1      }
C51 COMPILER V9.52.0.0   SYS_RUN                                                           12/29/2017 16:22:31 PAGE 3   

 114          
 115          
 116          void sys_run(void)
 117          {
 118   1          unsigned char set_speed = 0;
 119   1         
 120   1          //◊È∫œº¸∞¥œ¬2√Î∫Ûø™ ººÏ≤‚2Gø®µƒ–≈∫≈
 121   1          if(key_info.IsTouchedKey == 1 && key_info.WhichKey == KEY_WIFI)
 122   1          {
 123   2              Is_signal_check = 1;
 124   2              Clear_Touch_Info();
 125   2              TM1620_DispalyData(SENSOR_PM25,0);
 126   2              Buzzer_Signal_Check();
 127   2          }
 128   1          
 129   1          //»Áπ˚”–»À∞—≤÷√≈πÿ±’¡À£¨‘Úª˙∆˜Ω¯»Î¥˝ª˙◊¥Ã¨
 130   1          if(is_sys_auto_check == 0)
 131   1          {
 132   2              check_if_doorclose_manual();
 133   2          }
 134   1          
 135   1          
 136   1          
 137   1          if(charge_info.IsChargeType == 1 && charge_info.lefttime.l_time > 0 && Is_close_by_man == 0)
 138   1          {
 139   2              if(sys_mode == STANDBY)
 140   2              {          
 141   3                  sys_start();  
 142   3      
 143   3                  //«Â≥˝∞¥º¸–≈œ¢£¨∑¿÷π‘⁄ø™∆Ù…Ë±∏«∞∂‘∞¥º¸”–≤Ÿ◊˜£¨∑Ò‘Úµ±¥Úø™…Ë±∏ ±£¨÷Æ«∞±£¡Ùµƒ∞¥º¸≤Ÿ◊˜ª·¬Ì…œ÷¥––
 144   3                  Clear_Touch_Info();
 145   3              }
 146   2              
 147   2          }
 148   1        
 149   1          //»Áπ˚ «º∆∑—ƒ£ Ω£¨∂¯«“√ª”– ±º‰¡À£¨‘Ú∞¥º¸ ß–ß
 150   1          if(charge_info.IsChargeType == 1 && charge_info.lefttime.l_time == 0)
 151   1          {
 152   2              if(is_sys_auto_check == 0 && is_sys_manual_check == 0)
 153   2              {
 154   3                  if(sys_mode == RUNNING)
 155   3                  {
 156   4                      sys_stop();  
 157   4                  }
 158   3                  return;
 159   3              }
 160   2          }
 161   1        
 162   1        
 163   1          if(key_info.IsTouchedKey == 1)
 164   1          {
 165   2              switch(key_info.WhichKey)
 166   2              {
 167   3                case KEY_POWER:
 168   3                  if(is_sys_manual_check == 1)
 169   3                  {
 170   4                      sys_check_info.touch_key_check |= (1 << power_bit);
 171   4                  }
 172   3                  
 173   3                  if(sys_mode == STANDBY)
 174   3                  {
 175   4                      sys_start();             
C51 COMPILER V9.52.0.0   SYS_RUN                                                           12/29/2017 16:22:31 PAGE 4   

 176   4                  }
 177   3                  else if(sys_mode == RUNNING)
 178   3                  { 
 179   4                      sys_stop();              
 180   4                  }
 181   3                  break;
 182   3                case KEY_SPEED:
 183   3                  if(sys_mode == RUNNING)
 184   3                  {
 185   4                      Buzzer_Speed();
 186   4                      set_speed = speed_dang;
 187   4                      if(speed_dang < HIGH_SPEED )
 188   4                      {
 189   5                          set_speed++;
 190   5                      }
 191   4                      else if(speed_dang == HIGH_SPEED)
 192   4                      {
 193   5                          set_speed = QUIET_SPEED;
 194   5                      }
 195   4                      else
 196   4                      {
 197   5                          set_speed = 0;
 198   5                      }
 199   4                      Set_DC_Motor_Speed(set_speed);
 200   4                      
 201   4                      if(is_sys_manual_check == 1)
 202   4                      {
 203   5                          //sys_check_info.touch_key_check |= (1 << speed_bit);
 204   5                          if(speed_dang == QUIET_SPEED)
 205   5                          {
 206   6                              sys_check_info.touch_key_check |= (1 << quiet_speed_bit);
 207   6                          }
 208   5                          else if(speed_dang == LOW_SPEED)
 209   5                          {
 210   6                              sys_check_info.touch_key_check |= (1 << low_speed_bit);
 211   6                          }
 212   5                          else if(speed_dang == MID_SPEED)
 213   5                          {
 214   6                              sys_check_info.touch_key_check |= (1 << mid_speed_bit);
 215   6                          }
 216   5                          else if(speed_dang == HIGH_SPEED)
 217   5                          {
 218   6                              sys_check_info.touch_key_check |= (1 << high_speed_bit);
 219   6                          }
 220   5                      } 
 221   4                      
 222   4                      
 223   4                      //‘⁄◊‘∂Øƒ£ Ωœ¬£¨»Áπ˚ ÷∂Øµ˜Ω⁄∑Á¡ø¡À£¨‘Ú»°œ˚◊‘∂Øƒ£ Ω
 224   4                      if(run_mode == 1)
 225   4                      {
 226   5                          stop_sys_smart_mode();
 227   5                      }
 228   4                      
 229   4                  }
 230   3                  else
 231   3                  {
 232   4                      break;
 233   4                  }
 234   3                  break;
 235   3                case KEY_TIMER:  
 236   3                  if(is_sys_manual_check == 1)
 237   3                  {
C51 COMPILER V9.52.0.0   SYS_RUN                                                           12/29/2017 16:22:31 PAGE 5   

 238   4                      sys_check_info.touch_key_check |= (1 << timer_bit);
 239   4                  }             
 240   3                  break;
 241   3                case KEY_MODE: 
 242   3                  if(is_sys_manual_check == 1)
 243   3                  {
 244   4                      sys_check_info.touch_key_check |= (1 << mode_bit);
 245   4                  }             
 246   3                  break;
 247   3                case KEY_WIFI:
 248   3                  //control wifi to easylink mode  
 249   3                  if(is_sys_manual_check == 1)
 250   3                  {
 251   4                      sys_check_info.touch_key_check |= (1 << wifi_bit);
 252   4                  }           
 253   3                  break;            
 254   3                  
 255   3                  
 256   3                default:
 257   3                  break;
 258   3                  
 259   3              
 260   3              }
 261   2              if(key_info.IsTouchedKey == 1 && key_info.WhichKey != KEY_WIFI)
 262   2              {
 263   3                  Clear_Touch_Info();
 264   3              }
 265   2              
 266   2          }
 267   1          
 268   1          if(run_mode == 1)
 269   1          {
 270   2              sys_smart_mode();
 271   2          }
 272   1      
 273   1      }
 274          
 275          
 276          
 277          #define GET_SENSOR_TIME_INTERVAL    (2)
 278          #define RUN_CONTINUE_TIME    (1*60)
 279          #define STOP_CONTINUE_TIME   (10*60)   //10min
 280          #define STANDBY_UPDATA_DATA_INTERVAL  (15*60)   //15min
 281          //#define RUN_CONTINUE_TIME    (1*60)
 282          //#define STOP_CONTINUE_TIME   (1*60)   //10min
 283          //#define STANDBY_UPDATA_DATA_INTERVAL  (1*60)   //15min
 284          
 285          void display_pm_data(void)
 286          {
 287   1          static bit change_to_3min_updata = 0;
 288   1          static bit IsPowerOn = 0;
 289   1          static unsigned long get_pm_trigger_time = 0;
 290   1          static unsigned long standby_trigger_time = 0;
 291   1          static unsigned int temp_pm_value = 0;
 292   1         
 293   1          nowtime_s = get_sys_stime();
 294   1          
 295   1          if(nowtime_s <= GET_SENSOR_TIME_INTERVAL && get_pm_trigger_time >= (0xFFFFFFFF - GET_SENSOR_TIME_INTER
             -VAL))
 296   1          {
 297   2              get_pm_trigger_time = nowtime_s + GET_SENSOR_TIME_INTERVAL;
 298   2          }
C51 COMPILER V9.52.0.0   SYS_RUN                                                           12/29/2017 16:22:31 PAGE 6   

 299   1          
 300   1          // ÷‹∆⁄–‘ªÒ»°¥´∏–∆˜ ˝æ›£¨ ±º‰º‰∏Ù GET_SENSOR_TIME_INTERVAL £¨µ•Œªs
 301   1          if(nowtime_s >= get_pm_trigger_time)
 302   1          {
 303   2              PM25_value = Read_PMSensor_Data();
 304   2              //get_pm_trigger_time = nowtime + get_sensor_data_time_interval;
 305   2              get_pm_trigger_time = nowtime_s + (GET_SENSOR_TIME_INTERVAL | 0x00);
 306   2              
 307   2            
 308   2              //5√Î÷”∏¸–¬“ª¥Œ ˝¬Îπ‹œ‘ æµƒ ˝æ›
 309   2              if(is_sys_auto_check == 0)
 310   2              {
 311   3                  TM1620_DispalyData(SENSOR_PM25,display_pm_value);
 312   3              }
 313   2              
 314   2      
 315   2          }
 316   1          if(sys_mode == RUNNING)
 317   1          {
 318   2              if(IsPowerOn == 0)
 319   2              {
 320   3                  IsPowerOn = 1;
 321   3              }
 322   2              if(change_to_3min_updata == 1)
 323   2              {
 324   3                  change_to_3min_updata = 0;
 325   3              }
 326   2              
 327   2              if(nowtime_s <= (sys_start_time + (RUN_CONTINUE_TIME | 0x00)))
 328   2              {
 329   3                  //¥Úø™…Ë±∏∫Ûµƒ 60 √Îƒ⁄œ‘ æø™ª˙«∞µƒ ˝÷µ
 330   3                  if(nowtime_s <= 180)
 331   3                  {
 332   4                      //…Ë±∏∏’…œµÁ£¨¥À ±œ‘ æ µ ± ˝÷µ
 333   4                      if(PM25_value_bak < PM25_value)
 334   4                      {
 335   5                          display_pm_value = (unsigned int)PM25_value;
 336   5                          PM25_value_bak = (unsigned int)PM25_value;
 337   5                      }
 338   4                      else
 339   4                      {
 340   5                          display_pm_value = PM25_value_bak;
 341   5                      }
 342   4                  }
 343   3                  else
 344   3                  {
 345   4                      //¥À÷÷«Èøˆ «…Ë±∏“—æ≠…œµÁ“ª∂Œ ±º‰£¨¥”¥˝ª˙Ω¯»Î‘À––ƒ£ Ω£¨Œ™¡À∑¿÷πœ‘ æµƒ ˝÷µ…œ’«£¨œ‘ æ¥˝ª˙ ±µƒ
             - ˝÷µ
 346   4                      display_pm_value = (unsigned int)PM25_value_bak;           
 347   4                    
 348   4                  }
 349   3      
 350   3              }
 351   2              else
 352   2              {
 353   3                  //»°¡Ω¥ŒªÒ»°µΩµƒ ˝æ›µƒ∆Ωæ˘÷µ£¨∑¿÷π ˝æ›Ã¯±‰π˝øÏ
 354   3                  display_pm_value = ((unsigned int)PM25_value + PM25_value_bak) / 2;
 355   3                  PM25_value_bak = (unsigned int)PM25_value;
 356   3              }
 357   2      
 358   2          }
 359   1          else if(sys_mode == STANDBY)
C51 COMPILER V9.52.0.0   SYS_RUN                                                           12/29/2017 16:22:31 PAGE 7   

 360   1          {
 361   2              
 362   2              //œµÕ≥¥˝ª˙∫Û£¨’˝≥£«Èøˆœ¬PM2.5 ˝æ›ª·œ¬Ωµ£¨¥À¥¶ ˝æ›Ω¯––¥¶¿Ì£¨¥˝ª˙∫Û10∑÷÷”ƒ⁄»Áπ˚ ˝æ›œ¬Ωµ‘Úœ‘ æ∏’¥˝ª˙ 
             -±µƒ ˝æ›
 363   2              if(IsPowerOn == 0)
 364   2              {
 365   3                  //∏’ø™ª˙«∞3∑÷÷”ƒ⁄œ‘ æ µ ± ˝æ›
 366   3                  if(nowtime_s < (STANDBY_UPDATA_DATA_INTERVAL | 0x00))
 367   3                  {
 368   4                      if(PM25_value_bak < (unsigned int)PM25_value)
 369   4                      {
 370   5                          PM25_value_bak = (unsigned int)PM25_value;
 371   5                      }
 372   4                      display_pm_value = PM25_value_bak; 
 373   4                      goto exit;              
 374   4                  }
 375   3                  else
 376   3                  {
 377   4                      IsPowerOn = 1;
 378   4                      change_to_3min_updata = 1;
 379   4                      temp_pm_value = 0;
 380   4                      standby_trigger_time = nowtime_s + (STANDBY_UPDATA_DATA_INTERVAL | 0x00);
 381   4                  }
 382   3              }
 383   2              else
 384   2              {
 385   3                  if(change_to_3min_updata == 0)
 386   3                  {
 387   4                      if(nowtime_s < (sys_stop_time + (STOP_CONTINUE_TIME | 0x00)))
 388   4                      {
 389   5                          //¥”‘À––ƒ£ ΩΩ¯»Î¥˝ª˙∫Ûµƒ10minƒ⁄£¨PMµƒ ˝æ›≤ªƒ‹–°”⁄∏’Ω¯»Î¥˝ª˙ƒ£ Ω ±µƒ ˝æ›
 390   5                          if(PM25_value < PM25_value_bak)
 391   5                          {
 392   6                              //»°∆Ωæ˘÷µ «Œ™¡À∑¿÷πœ‘ æ ˝æ›±‰ªØ¥Û
 393   6                              display_pm_value = (PM25_value_bak + display_pm_value) / 2;
 394   6                          }
 395   5                          else
 396   5                          {
 397   6                              //∑¿÷π∏’Ω¯»Î¥˝ª˙ ± ˝æ›±‰ªØ∑∂ŒßÃ´¥Û
 398   6                              display_pm_value = ((unsigned int)PM25_value + display_pm_value + PM25_value_bak) 
             -/ 3;
 399   6                          }                        
 400   5                      } 
 401   4                      else
 402   4                      {
 403   5                          change_to_3min_updata = 1; 
 404   5                          temp_pm_value = 0;
 405   5                          standby_trigger_time = nowtime_s + (STANDBY_UPDATA_DATA_INTERVAL | 0x00);
 406   5                      }                  
 407   4                  }
 408   3                  else
 409   3                  {
 410   4                      //ªÒ»° STANDBY_UPDATA_DATA_INTERVAL  ∑÷÷”ƒ⁄◊Ó¥Ûµƒ ˝æ›£¨”√”⁄œ‘ æ
 411   4                      if(temp_pm_value <= (unsigned int)PM25_value)
 412   4                      {
 413   5                          temp_pm_value = (unsigned int)PM25_value;
 414   5      
 415   5                      }
 416   4                      
 417   4                      if(PM25_value_bak < (unsigned int)PM25_value)
 418   4                      {
 419   5                          PM25_value_bak = (unsigned int)PM25_value;
C51 COMPILER V9.52.0.0   SYS_RUN                                                           12/29/2017 16:22:31 PAGE 8   

 420   5                          display_pm_value = ((unsigned int)PM25_value + display_pm_value) / 2;
 421   5                              
 422   5                      }               
 423   4                  
 424   4                      if(nowtime_s >= standby_trigger_time)
 425   4                      {
 426   5                          //…œ¥Œœ‘ æµƒ ˝æ›∫Õ’‚¥ŒªÒ»°µΩµƒ◊Ó¥Û÷µ«Û∫Õ£¨»ª∫Û»°∆Ωæ˘÷µ£¨≤ª»ªø…ƒ‹ª·µº÷¬2¥Œœ‘ æµƒ ˝æ›Ã¯±
             -‰±»Ωœ¥Û
 427   5                          display_pm_value = (temp_pm_value + PM25_value_bak) / 2;
 428   5                          PM25_value_bak = display_pm_value;
 429   5                          temp_pm_value = 0;
 430   5                           
 431   5                          standby_trigger_time += (STANDBY_UPDATA_DATA_INTERVAL | 0x00);
 432   5                        
 433   5                        
 434   5      //                    temp_low = standby_trigger_time & 0xFFFF;     
 435   5      //                    temp_high = (standby_trigger_time >> 16) & 0xFFFF;   
 436   5      //                    mymemset(debug_buff,0,30);
 437   5      //                    sprintf(debug_buff,"trigger time:0x%x%4x\n",(unsigned int)temp_high,(unsigned int)te
             -mp_low);
 438   5      //                    DEBUG_Uart_Sendbytes(debug_buff,mystrlen(debug_buff));  
 439   5                      } 
 440   4                    
 441   4                  }
 442   3            
 443   3              }
 444   2              
 445   2          }
 446   1          
 447   1       exit:
 448   1          
 449   1          if(display_pm_value < 2)
 450   1          {
 451   2              display_pm_value = 2;
 452   2          }
 453   1          
 454   1          return;
 455   1          
 456   1          
 457   1      }
 458          
 459          
 460          
 461          //‘⁄◊‘∂Øƒ£ Ωœ¬£¨∑Áª˙µµŒª«–ªª∫Û10√Î÷”ƒ⁄≤ª‘ –Ì‘Ÿ¥Œ«–ªª£¨∑Ò‘ÚPM‘⁄¡ŸΩÁ÷µ ±ª·∑«≥£∆µ∑±µƒ«–ªªµµŒª£¨ÃÂ—È≤ª∫√
 462          void sys_smart_mode(void)
 463          {
 464   1          
 465   1          static bit speed_changed = 0;   //∑¿÷πPM≈®∂»‘⁄¡ŸΩÁ÷µ ±£¨∆µ∑±«–ªªµµŒª
 466   1          static bit IsLedChange = 0;
 467   1          static unsigned long speed_changed_time = 0;   //…œ¥Œ«–ªª∑Áµ≤ ±µƒ ±º‰
 468   1        
 469   1          const unsigned char code speed_continue_time = 10;  //10√Î÷”ƒ⁄≤ªƒ‹‘Ÿ¥Œ«–ªª∑Áµ≤
 470   1          
 471   1        
 472   1          if((charge_info.IsChargeType == 1 && charge_info.lefttime.l_time == 0) || sys_mode == STANDBY)
 473   1          {
 474   2              return;
 475   2          }
 476   1          
 477   1          nowtime_s = get_sys_stime();
 478   1          
 479   1          if(speed_changed == 1)
C51 COMPILER V9.52.0.0   SYS_RUN                                                           12/29/2017 16:22:31 PAGE 9   

 480   1          {
 481   2              //∑Áª˙µµŒª∏’«–ªªπ˝£¨10√Î“‘∫Û≤≈ƒ‹«–ªª
 482   2              if(nowtime_s <= (speed_changed_time + speed_continue_time))
 483   2              {
 484   3                  return;
 485   3              }
 486   2              else
 487   2              {
 488   3                  speed_changed = 0;
 489   3              }
 490   2              
 491   2          }
 492   1          
 493   1          if(display_pm_value < PM25_QUIET_SPEED )
 494   1          {
 495   2              if(speed_dang != QUIET_SPEED)
 496   2              {
 497   3                  speed_dang = QUIET_SPEED;
 498   3                  IsSpeedChanged = 1;
 499   3                  speed_changed = 1;
 500   3                  IsLedChange = 1;
 501   3              }       
 502   2          }
 503   1          else if(display_pm_value < PM25_LOW_SPEED)
 504   1          {
 505   2              if(speed_dang != LOW_SPEED)
 506   2              {
 507   3                  speed_dang = LOW_SPEED;
 508   3                  IsSpeedChanged = 1;
 509   3                  speed_changed = 1;
 510   3                  IsLedChange = 1;
 511   3              }  
 512   2          }
 513   1          else
 514   1          {
 515   2              if(speed_dang != HIGH_SPEED)
 516   2              {
 517   3                  speed_dang = HIGH_SPEED;
 518   3                  IsSpeedChanged = 1;
 519   3                  speed_changed = 1;
 520   3                  IsLedChange = 1;
 521   3              }
 522   2          }   
 523   1      
 524   1          if(IsLedChange == 1)
 525   1          {
 526   2              //◊‘∂Øƒ£ Ωœ¬£¨∑Áµ≤±‰∫Û£¨LEDµ∆“≤“™œ‡”¶µƒ±‰ªØ
 527   2              TM1620_LED_Control(speed_dang + 1,LED_ON);
 528   2              IsLedChange = 0; 
 529   2      
 530   2              dev_status = 1;          
 531   2          }  
 532   1      
 533   1          
 534   1      
 535   1      }
 536          
 537          
 538          
 539          
 540          
 541          //œµÕ≥‘À–– ±£¨»Áπ˚”–»À ÷∂Ø∞—≤÷√≈πÿ±’¡À£¨‘Úª˙∆˜Ω¯»Î¥˝ª˙ƒ£ Ω
C51 COMPILER V9.52.0.0   SYS_RUN                                                           12/29/2017 16:22:31 PAGE 10  

 542          //ºÏ≤‚∑Ω∑®£∫100msºÏ≤‚“ª¥Œ≤÷√≈£¨»Áπ˚¡¨–¯2√Î÷”≤÷√≈∂º «πÿ±’µƒ£¨‘Úª˙∆˜Ω¯»Î¥˝ª˙ƒ£ Ω
 543          #define MAX_DOOR_CLOSE_TIMES    20
 544          void check_if_doorclose_manual(void)
 545          {
 546   1          static unsigned char check_doorclose_times = 0;
 547   1       
 548   1          if(sys_mode == RUNNING)
 549   1          {
 550   2              nowtime_s = get_sys_stime();
 551   2              if(nowtime_s >= (sys_start_time + 10))
 552   2              {
 553   3                  if(g_100ms_flag == 1)
 554   3                  {
 555   4                      if(DOOR_CHECK_PIN == 1)
 556   4                      {
 557   5                          check_doorclose_times += 1;
 558   5                      }
 559   4                      else
 560   4                      {
 561   5                          check_doorclose_times = 0;
 562   5                      }
 563   4                      
 564   4                      if(check_doorclose_times >= MAX_DOOR_CLOSE_TIMES)
 565   4                      {
 566   5                          if(sys_mode == RUNNING)
 567   5                          {
 568   6                              sys_stop();
 569   6                              Is_close_by_man = 1;
 570   6                              check_doorclose_times = 0;
 571   6                          }
 572   5      
 573   5                      }
 574   4                  }
 575   3              }
 576   2          }
 577   1      
 578   1      }
 579          
 580          
 581          void set_sys_to_smart_mode(void)
 582          {
 583   1          run_mode = 1;
 584   1          TM1620_LED_Control(LED_AUTO_MODE,LED_ON);
 585   1      }
 586          
 587          void stop_sys_smart_mode(void)
 588          {
 589   1          run_mode = 0;
 590   1          TM1620_LED_Control(LED_AUTO_MODE,LED_OFF);
 591   1      }
 592          
 593          //œµÕ≥◊‘ºÏ
 594          //µ±≤÷√≈πÿ±’ ±£¨≤÷√≈ºÏ≤‚“˝Ω≈ «∏ﬂµÁ∆Ω£ªµ±≤÷√≈¥Úø™ ±£¨≤÷√≈ºÏ≤‚“˝Ω≈ «µÕµÁ∆Ω
 595          //status «œµÕ≥ºÏ≤‚±Í÷æ£¨bit0±Ì æ≤÷√≈£¨bit1±Ì æ∑Áª˙£¨bit2±Ì æuvµ∆
 596          
 597          //¥À∫Ø ˝µƒ÷¥––º‰∏Ù±ÿ–Î «100ms£¨“ÚŒ™FGcountµƒ≤…ºØ÷‹∆⁄ «100ms
 598          void sys_dev_auto_check(void)
 599          {
 600   1      
 601   1          //œµÕ≥ºÏ≤‚UV∫Õ∑Áª˙µƒ ±º‰
 602   1          static const unsigned long code sys_check_time = 30;
 603   1          //unsigned long nowtime = 0;
C51 COMPILER V9.52.0.0   SYS_RUN                                                           12/29/2017 16:22:31 PAGE 11  

 604   1        
 605   1          //step0  πÿª˙
 606   1          if(sys_check_info.step == 0)
 607   1          {
 608   2              if(sys_mode == RUNNING)
 609   2              {
 610   3                  sys_stop();
 611   3                  is_sys_auto_check = 1;
 612   3              }
 613   2              sys_check_info.step += 1;
 614   2              is_auto_check_complete = 0;
 615   2          }     
 616   1          else if(sys_check_info.step == 1)  //step1  ºÏ≤‚≤÷√≈ «∑Òø…“‘πÿ±’ªÚ’ﬂºÏ≤‚ø™πÿ «∑Ò”–Œ Ã‚
 617   1          {        
 618   2              if(beats == 0)
 619   2              {
 620   3                  if(DOOR_CHECK_PIN == 0)
 621   3                  {
 622   4                      sys_check_info.status = ((1 << door_bit) | (1 << fan_bit) | (1 << uv_bit));
 623   4                      is_auto_check_complete = 1;
 624   4                      goto exit;
 625   4                  }
 626   3                  else
 627   3                  {
 628   4                      sys_check_info.step += 1;
 629   4                  }
 630   3              }        
 631   2          }
 632   1          else if(sys_check_info.step == 2)    //step2  ¥Úø™ª˙∆˜
 633   1          {       
 634   2              sys_start();
 635   2              sys_check_info.step += 1;             
 636   2          }
 637   1          else if(sys_check_info.step == 3)    //step3 ºÏ≤‚≤÷√≈ «∑Ò¥Úø™
 638   1          {
 639   2              if(beats == 0)
 640   2              {
 641   3                  if(DOOR_CHECK_PIN == 0)
 642   3                  {
 643   4                      sys_check_info.status = 0;
 644   4                      sys_check_info.step += 1;
 645   4                  }
 646   3                  else
 647   3                  {  
 648   4                      sys_check_info.status = ((1 << door_bit) | (1 << fan_bit) | (1 << uv_bit));
 649   4                      is_auto_check_complete = 1;
 650   4                      goto exit;
 651   4                  }
 652   3                  FGcount = 0;
 653   3              }     
 654   2          }
 655   1          else if(sys_check_info.step == 4)    //step4  ºÏ≤‚∑Áª˙∫ÕUVµ∆
 656   1          {
 657   2              nowtime_s = get_sys_stime();
 658   2              //ºÏ≤‚∑Áª˙∫ÕUVµ∆”––ß ±º‰20√Î
 659   2              if(nowtime_s >= (sys_start_time + 10) && nowtime_s <= (sys_start_time + sys_check_time))
 660   2              {
 661   3                  if(IsUVfault == 1)
 662   3                  {
 663   4                      sys_check_info.status |= (1 << uv_bit);
 664   4                  }
 665   3                  
C51 COMPILER V9.52.0.0   SYS_RUN                                                           12/29/2017 16:22:31 PAGE 12  

 666   3                  sys_check_info.fg_count = FGcount;
 667   3                  FGcount = 0;  
 668   3                  if(sys_check_info.fg_count < 7 || sys_check_info.fg_count > 17)
 669   3                  {              
 670   4                      if(sys_check_info.fan_check_fault_times < 0xFF)
 671   4                      {
 672   5                          sys_check_info.fan_check_fault_times += 1;
 673   5                      }
 674   4                  }
 675   3                               
 676   3                              
 677   3              }
 678   2              else if(nowtime_s > (sys_start_time + sys_check_time))
 679   2              {
 680   3                  //‘⁄Dcmoto_adj()∫Ø ˝÷–≈–∂œFGcount∑¥¿°–≈∫≈£¨100msºÏ≤‚“ª¥Œ£¨20√Îπ≤ºÏ≤‚200¥Œ£¨∑¥¿°–≈∫≈≤¢≤ª «“ª∏ˆπ
             -Ã∂®÷µ£¨∂¯ «‘⁄“ª∂®∑∂Œßƒ⁄≤®∂Ø£¨∞¥≥ˆ¥Ì∏≈¬ Ω¯––ºÏ≤‚
 681   3                  if(sys_check_info.fan_check_fault_times > 45)
 682   3                  {
 683   4                      sys_check_info.status |= (1 << fan_bit);
 684   4                  }
 685   3                  if((int)PM25_value <= 0)
 686   3                  {
 687   4                      sys_check_info.status |= (1 << pm25_bit);
 688   4                  }
 689   3                  is_auto_check_complete = 1;
 690   3              }
 691   2          }
 692   1         
 693   1          
 694   1      exit:
 695   1          if(is_auto_check_complete == 1)
 696   1          {
 697   2              stop_sys_auto_check();            
 698   2          }
 699   1      }
 700          
 701          
 702          void start_sys_auto_check(void)
 703          {
 704   1          is_sys_auto_check = 1;
 705   1          sys_check_info.step = 0;
 706   1          sys_check_info.status = 0;
 707   1          sys_check_info.fan_check_fault_times = 0;  
 708   1        
 709   1          is_upload_auto_check_result = 0;
 710   1          
 711   1      }
 712          
 713          void stop_sys_auto_check(void)
 714          {
 715   1          is_sys_auto_check = 0;
 716   1          is_auto_check_complete = 0;
 717   1          //…œ¥´◊‘∂Ø≤‚ ‘Ω·π˚
 718   1          sys_check_auto_result_upload();
 719   1          if(sys_mode == RUNNING)
 720   1          {
 721   2              sys_stop();
 722   2          }
 723   1      }
 724          
 725          void start_sys_manual_check(void)
 726          {
C51 COMPILER V9.52.0.0   SYS_RUN                                                           12/29/2017 16:22:31 PAGE 13  

 727   1          is_sys_manual_check = 1;
 728   1          sys_check_info.touch_key_check = 0;
 729   1          
 730   1          is_upload_manual_check_result = 0;
 731   1        
 732   1          sys_check_info.start_time = get_sys_stime();
 733   1          Buzzer_Get_Charge();
 734   1          
 735   1      }
 736          
 737          void check_if_stop_manual_check(void)
 738          {
 739   1          // ÷∂ØºÏ≤‚µƒ◊Ó¥Û ±º‰£¨»Áπ˚3∑÷÷”ƒ⁄≤ªÕ£÷π‘Ú◊‘∂ØÕ£÷π
 740   1          const unsigned long check_max_time = 180;
 741   1          if(get_sys_stime() >= (sys_check_info.start_time + check_max_time))
 742   1          {        
 743   2              stop_sys_manual_check();
 744   2          }
 745   1      }
 746          
 747          
 748          void stop_sys_manual_check(void)
 749          {
 750   1          is_sys_manual_check = 0;
 751   1          //…œ¥´ ÷∂Ø≤‚ ‘Ω·π˚
 752   1          sys_check_manual_result_upload();
 753   1          Buzzer_Get_Charge();
 754   1      }
 755          
 756          
 757          
 758          #define AUTO_CHECK_(result,bit_num) ((result & (1 << bit_num))?"FAULT":"OK")
 759          #define MANUL_CHECK_(result,bit_num) ((result & (1 << bit_num))?"OK":"FAULT")
 760          
 761          void sys_check_auto_result_upload(void)
 762          {
 763   1          unsigned char result = 0;
 764   1        
 765   1          is_upload_auto_check_result = 1;
 766   1        
 767   1          result = sys_check_info.touch_key_check;
 768   1          mymemset(m26_cmd_info.sendtring,0,sizeof(m26_cmd_info.sendtring));
 769   1          sprintf(m26_cmd_info.sendtring,"check result:0x%x,door:%s,fan;%s,uv:%s,pm_bit:%s,pm:%d",result,AUTO_CH
             -ECK_(result,door_bit),AUTO_CHECK_(result,fan_bit),
 770   1                          AUTO_CHECK_(result,uv_bit),AUTO_CHECK_(result,pm25_bit),(unsigned int)(PM25_value));
 771   1          DEBUG_Uart_Sendbytes(m26_cmd_info.sendtring,mystrlen(m26_cmd_info.sendtring)); 
 772   1      }
 773          
 774          
 775          
 776          void sys_check_manual_result_upload(void)
 777          {
 778   1          unsigned char result = 0;
 779   1        
 780   1          is_upload_manual_check_result = 1;
 781   1        
 782   1          result = sys_check_info.status;
 783   1          mymemset(m26_cmd_info.sendtring,0,sizeof(m26_cmd_info.sendtring));
 784   1          sprintf(m26_cmd_info.sendtring,"check result:0x%x,power:%s,quiet_p;%s,low_p;%s,mid_p;%s,high_p;%s,time
             -r:%s,mode:%s,wifi:%s",result,MANUL_CHECK_(result,power_bit),MANUL_CHECK_(result,quiet_speed_bit),
 785   1                          MANUL_CHECK_(result,low_speed_bit),MANUL_CHECK_(result,mid_speed_bit),MANUL_CHECK_(res
             -ult,high_speed_bit),
C51 COMPILER V9.52.0.0   SYS_RUN                                                           12/29/2017 16:22:31 PAGE 14  

 786   1                          MANUL_CHECK_(result,timer_bit),MANUL_CHECK_(result,mode_bit),MANUL_CHECK_(result,wifi_
             -bit));
 787   1          DEBUG_Uart_Sendbytes(m26_cmd_info.sendtring,mystrlen(m26_cmd_info.sendtring)); 
 788   1      }
 789          
 790          
 791          
 792          
 793          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   3135    ----
   CONSTANT SIZE    =    160    ----
   XDATA SIZE       =     15       7
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      4    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
